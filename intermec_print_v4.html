<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intermec PF4i Web Serial Printer</title>
    <style>
        body { 
            font-family: sans-serif; 
            line-height: 1.6; 
            padding: 2em; 
            max-width: 900px; 
            margin: 0 auto; 
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 0.5em; }
        .subtitle { color: #666; margin-bottom: 2em; }
        textarea { 
            width: 100%; 
            height: 200px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            margin-bottom: 1em;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
        }
        button { 
            font-size: 1em; 
            padding: 12px 24px; 
            cursor: pointer; 
            border: none; 
            border-radius: 5px; 
            transition: background-color 0.3s;
        }
        .primary-btn {
            background-color: #007bff; 
            color: white;
        }
        .primary-btn:hover { background-color: #0056b3; }
        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
        .secondary-btn:hover { background-color: #545b62; }
        .info { 
            background-color: #e7f3ff; 
            border-left: 5px solid #007bff; 
            padding: 15px; 
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f1b0b7; }
        .status.info { background-color: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
        code { background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .examples {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 1em 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Intermec PF4i Web Serial Printer üñ®Ô∏è</h1>
        <p class="subtitle">Send IPL (Intermec Printer Language) commands to your Intermec PF4i printer</p>
        
        <div class="warning">
            <strong>Flow Control Issue:</strong>
            <p>If your printer has <strong>RTS/CTS flow control</strong> enabled, you may need to change it to <strong>"None"</strong> in the printer's setup menu. Hardware flow control can cause communication issues with the Web Serial API.</p>
            <br>
            <strong>Setup Requirements:</strong>
            <ul>
                <li>Use <strong>RS-232 to USB adapter cable</strong> (NOT standard USB A-to-B)</li>
                <li>Ensure printer is powered on and paper is loaded</li>
                <li>Set flow control to "None" in printer settings if having issues</li>
                <li>Match baud rate between printer and web app</li>
                <li>Use Chrome or Edge browser (Web Serial API required)</li>
            </ul>
        </div>

        <div class="examples">
            <strong>Sample IPL Commands:</strong>
            <ul>
                <li><code>Simple Text</code> - Basic text label</li>
                <li><code>Barcode</code> - Code 128 barcode example</li>
                <li><code>Test Pattern</code> - Printer test pattern</li>
            </ul>
        </div>

        <textarea id="iplCode" placeholder="Enter your IPL commands here..."></textarea>
        
        <div style="display: flex; gap: 10px; margin-bottom: 1em; align-items: center;">
            <label for="baudRate">Baud Rate:</label>
            <select id="baudRate">
                <option value="9600" selected>9600</option>
                <option value="19200">19200</option>
                <option value="38400">38400</option>
                <option value="115200">115200</option>
            </select>
            
            <label for="flowControl">Flow Control:</label>
            <select id="flowControl">
                <option value="none" selected>None</option>
                <option value="hardware">RTS/CTS (Hardware)</option>
            </select>
        </div>

        <div class="button-group">
            <button id="printButton" class="primary-btn">üñ®Ô∏è Print Label</button>
            <button id="testButton" class="secondary-btn">üß™ Minimal Test</button>
            <button id="fullTestButton" class="secondary-btn">üìã Full Test</button>
            <button id="barcodeButton" class="secondary-btn">üìä Load Barcode Example</button>
            <button id="clearButton" class="secondary-btn">üóëÔ∏è Clear</button>
        </div>

        <div id="statusDiv"></div>

        <div class="info">
            <h3>Troubleshooting Tips:</h3>
            <ul>
                <li><strong>No response?</strong> Check cable connection and baud rate</li>
                <li><strong>Garbled output?</strong> Verify IPL command syntax</li>
                <li><strong>Permission denied?</strong> Make sure to grant serial port access</li>
                <li><strong>Printer not found?</strong> Try different USB ports or restart the printer</li>
            </ul>
        </div>
    </div>

    <script>
        // Status management
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Sample IPL commands optimized for IPL 2.78.1
        const sampleCommands = {
            simple: `<STX>L
H10
o70,50
f0
S l1;0,0,68,71,104
T 20,10,0,1,1;Hello World!
T 20,35,0,1,1;IPL 2.78.1 Test
T 20,55,0,1,1;Web Serial API
P1,1
<ETX>`,
            
            barcode: `<STX>L
H10
o70,50
f0
S l1;0,0,68,71,104
T 20,10,0,1,1;Barcode Test:
B 20,30,0,1,3,6,60,B;"123456789"
T 20,100,0,1,1;123456789
P1,1
<ETX>`,
            
            test: `<STX>L
H10
o70,50
f0
S l1;0,0,68,71,104
T 10,10,0,3,1;TEST LABEL
T 10,40,0,1,1;IPL Version: 2.78.1
T 10,55,0,1,1;Status: Ready
T 10,70,0,1,1;${new Date().toLocaleDateString()}
P1,1
<ETX>`,

            minimal: `<STX>L
H8
f0
T 50,50,0,3,1;HELLO
P1
<ETX>`
        };

        // Convert readable format to actual control characters
        function formatIplCommand(command) {
            return command
                .replace(/<STX>/g, '\x02')
                .replace(/<ETX>/g, '\x03')
                .replace(/\n/g, '\r');
        }

        // Initialize with simple example
        document.getElementById('iplCode').value = sampleCommands.simple;

        // Button event listeners
        document.getElementById('printButton').addEventListener('click', () => {
            const iplCommand = document.getElementById('iplCode').value;
            if (!iplCommand.trim()) {
                showStatus('Please enter an IPL command before printing.', 'error');
                return;
            }
            printToIntermec(iplCommand);
        });

        document.getElementById('testButton').addEventListener('click', () => {
            document.getElementById('iplCode').value = sampleCommands.minimal;
            showStatus('Minimal test command loaded. This should work with any IPL printer.', 'info');
        });

        document.getElementById('fullTestButton').addEventListener('click', () => {
            document.getElementById('iplCode').value = sampleCommands.test;
            showStatus('Full test command loaded with printer info and date.', 'info');
        });

        document.getElementById('barcodeButton').addEventListener('click', () => {
            document.getElementById('iplCode').value = sampleCommands.barcode;
            showStatus('Barcode example loaded. Modify the barcode data as needed.', 'info');
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            document.getElementById('iplCode').value = '';
            showStatus('Command area cleared.', 'info');
        });

        /**
         * Connects to serial port and sends IPL command to Intermec printer
         * @param {string} iplCommand - The IPL command string to send
         */
        async function printToIntermec(iplCommand) {
            // Check for Web Serial API support
            if (!("serial" in navigator)) {
                showStatus('Web Serial API is not supported. Please use Chrome or Edge browser.', 'error');
                return;
            }

            showStatus('Requesting serial port access...', 'info');

            try {
                // Request serial port access
                const port = await navigator.serial.requestPort();
                
                showStatus('Opening connection to printer...', 'info');

                // Get user-selected settings
                const baudRate = parseInt(document.getElementById('baudRate').value);
                const flowControl = document.getElementById('flowControl').value;
                
                // Open port with selected settings
                await port.open({ 
                    baudRate: baudRate,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: flowControl
                });

                showStatus('Connected! Sending print command...', 'info');

                // Get writer for sending data
                const writer = port.writable.getWriter();

                // Format and encode the IPL command
                const formattedCommand = formatIplCommand(iplCommand);
                const data = new TextEncoder().encode(formattedCommand);

                console.log('Sending IPL command:', formattedCommand.replace(/\x02/g, '<STX>').replace(/\x03/g, '<ETX>').replace(/\r/g, '\\r'));

                // Send command to printer
                await writer.write(data);

                // Add small delay to ensure command is processed
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Clean up
                writer.releaseLock();
                
                showStatus('Closing connection...', 'info');
                await port.close();
                
                showStatus('‚úÖ Print command sent successfully! Check your printer.', 'success');

            } catch (error) {
                console.error('Printing error:', error);
                
                if (error.name === 'NotFoundError') {
                    showStatus('‚ùå No serial port selected. Please try again and select your printer.', 'error');
                } else if (error.name === 'InvalidStateError') {
                    showStatus('‚ùå Port communication error. Check cable and printer power.', 'error');
                } else if (error.name === 'NetworkError') {
                    showStatus('‚ùå Communication failed. Verify baud rate and cable connection.', 'error');
                } else {
                    showStatus(`‚ùå Printing failed: ${error.message}`, 'error');
                }
            }
        }

        // Initialize
        showStatus('Ready to print. Load a sample command or enter your own IPL code.', 'info');
    </script>
</body>
</html>